/*!
 * @author Jan Nejedly support@3b-fly.eu
 * @copyright Jan Nejedly
 * @version 2.0.0
 * @license see license in 'LICENSE' file
*/

var bbbfly=bbbfly||{};bbbfly.map=bbbfly.map||{};bbbfly.map.map={};bbbfly.map.layer={mapbox_tile:{},mapbox_style:{}};bbbfly.map.map._onCreated=function(a){a.CreateMap();return!0};bbbfly.map.map._onUpdated=function(){var a=this.GetMap();a&&"function"===typeof a.invalidateSize&&a.invalidateSize()};bbbfly.map.map._dispose=function(){this.DestroyMap();this.Dispose.callParent()};bbbfly.map.map._getMap=function(){return this._map};
bbbfly.map.map._createMap=function(){if(this.GetMap())return!0;var a={center:[0,0],zoom:0,fadeAnimation:!0,zoomAnimation:!0,markerZoomAnimation:!0};if(Object.isObject(this.MaxBounds)||Array.isArray(this.MaxBounds))a.maxBounds=this.MaxBounds;Number.isNumber(this.MinZoom)&&(a.minZoom=this.MinZoom,a.zoom=this.MinZoom);Number.isNumber(this.MaxZoom)&&(a.maxZoom=this.MaxZoom);String.isString(this.Crs)&&(a.crs=L.CRS[this.Crs]);a=this.DoCreateMap(a);if(!a)return!1;this.AddLayers(this.Layers);a.getZoom&&this.OnZoomChanged&&
this.OnZoomChanged(a.getZoom());return!0};bbbfly.map.map._doCreateMap=function(a){return!this.GetMap()&&this.Controls.Map&&(a=L.map(this.Controls.Map.ID,a))?(a.Owner=this,a.on("zoomend",bbbfly.map.map._onMapZoomEnd),this._map=a):null};bbbfly.map.map._destroyMap=function(){var a=this.GetMap();return a?(a.remove(),!0):!1};bbbfly.map.map._setMaxBounds=function(a){Array.isArray(a)&&(a=new L.latLngBounds(a));if(a&&a.isValid&&a.isValid()){this.MaxBounds=a;var b=this.GetMap();b&&b.setMaxBounds(a);return!0}return!1};
bbbfly.map.map._setBoundsPadding=function(a){return Number.isNumber(a)?(this.BoundsPadding=a,!0):!1};bbbfly.map.map._fitBounds=function(a,b){var c=this.GetMap();if(!c)return!1;!a&&this.MaxBounds&&(a=this.MaxBounds);!b&&this.BoundsPadding&&(b=this.BoundsPadding);return a&&a.isValid&&a.isValid()?(Number.isNumber(b)||(b=0),c.fitBounds(a,{padding:[b,b],animate:!!this.Animate}),!0):!1};bbbfly.map.map._setMinZoom=function(a){if(Number.isNumber(a)){this.MinZoom=a;var b=this.GetMap();b&&b.setMinZoom(a);return!0}return!1};
bbbfly.map.map._setMaxZoom=function(a){if(Number.isNumber(a)){this.MaxZoom=a;var b=this.GetMap();b&&b.setMaxZoom(a);return!0}return!1};bbbfly.map.map._enableAnimation=function(a){if(a===this.Animate)return!1;this.Animate=!!a;return!0};bbbfly.map.map._setView=function(a,b){var c=this.GetMap();if(c){if("undefined"===typeof a||null===a)a=c.getCenter();if("undefined"===typeof b||null===b)b=c.getZoom();c.setView(a,b,{animate:!!this.Animate});return!0}return!1};
bbbfly.map.map._setZoom=function(a){return this.SetView(null,a)};bbbfly.map.map._getZoom=function(){var a=this.GetMap();return a?a.getZoom():null};bbbfly.map.map._zoomIn=function(a){var b=this.GetMap();return b?(b.zoomIn(a,{animate:!!this.Animate}),!0):!1};bbbfly.map.map._zoomOut=function(a){var b=this.GetMap();return b?(b.zoomOut(a,{animate:!!this.Animate}),!0):!1};
bbbfly.map.map._onMapZoomEnd=function(a){if((a=a.target)&&"function"===typeof a.getZoom){var b=a.Owner;b&&"function"===typeof b.OnZoomChanged&&b.OnZoomChanged(a.getZoom())}};bbbfly.map.map._setCenter=function(a){return this.SetView(a,null)};bbbfly.map.map._getCenter=function(){var a=this.GetMap();return a?a.getCenter():null};bbbfly.map.map._getLayer=function(a){return String.isString(a)?(a=this._layers[a])?a:null:null};
bbbfly.map.map._addLayers=function(a){if(!Array.isArray(a))return!1;for(var b in a)if(!this.AddLayer(a[b]))return!1;return!0};
bbbfly.map.map._addLayer=function(a){if(!Object.isObject(a))return!1;var b=this.GetMap();if(!b)return!1;var c=this.LayerInterface(a.Type);if(!Object.isObject(c))return!1;ng_MergeVar(a,this.DefaultLayer);var d={};if(Object.isObject(c.map))for(var e in a){var f=c.map[e];f&&(d[f]=a[e])}Object.isObject(c.options)&&ng_MergeVar(d,c.options);if("function"===typeof c.onCreateOptions)c.onCreateOptions(d);e=null;switch(c.type){case "L.ImageOverlay":e=L.tileLayer.wms(d.url,d.bounds,d);break;case "L.TileLayer":e=
L.tileLayer(d.url,d);break;case "L.TileLayer.wms":e=L.tileLayer.wms(d.url,d);break;case "L.esri.TiledMapLayer":e=L.esri.tiledMapLayer(d);break;case "L.esri.DynamicMapLayer":e=L.esri.dynamicMapLayer(d)}return e?(String.isString(a.Id)?this.RemoveLayer(a.Id):a.Id="_L"+this._layerId++,e.addTo(b),this._layers[a.Id]=e,!0):!1};bbbfly.map.map._removeLayers=function(a){if(Array.isArray(a))for(var b in a){if(!this.RemoveLayer(a[b]))return!1}else for(var c in this._layers)if(!this.RemoveLayer(c))return!1;return!0};
bbbfly.map.map._removeLayer=function(a){if(!String.isString(a))return!1;var b=this._layers[a];return b?(delete this._layers[a],"function"===typeof b.remove&&b.remove(),!0):!1};bbbfly.map.map._layerInterface=function(a,b){if(String.isString(a)&&(a=bbbfly.Map[a],Object.isObject(a)))return Object.isObject(b)?ng_MergeVar(b,a):b=a,a.extends&&this.LayerInterface(a.extends,b),b};
bbbfly.map.layer.mapbox_tile._oncreateOptions=function(a){!String.isString(a.url)&&String.isString(a.mapId)&&(a.url="https://api.mapbox.com/v4/"+a.mapId+"/{z}/{x}/{y}.png",String.isString(a.accessToken)&&(a.url+="?access_token="+a.accessToken));delete a.mapId;delete a.accessToken};
bbbfly.map.layer.mapbox_style._oncreateOptions=function(a){if(!String.isString(a.url)&&String.isString(a.styleUrl)){var b=this.pattern.exec(a.styleUrl);b&&(a.url="https://api.mapbox.com/styles/v1/"+b[1]+"/tiles/{z}/{x}/{y}{r}",String.isString(a.accessToken)&&(a.url+="?access_token="+a.accessToken),b=b[3],String.isString(b)&&(a.url+="&"+b))}delete a.styleUrl;delete a.accessToken};
bbbfly.Map=function(a,b,c){a=a||{};ng_MergeDef(a,{ParentReferences:!1,Data:{Crs:bbbfly.Map.crs.PseudoMercator,BoundsPadding:1,MaxBounds:null,MinZoom:null,MaxZoom:null,Animate:!0,DefaultLayer:{ZIndex:1,Opacity:1,ClassName:"",CrossOrigin:!1},Layers:[],_map:null,_layers:{},_layerId:1},OnCreated:bbbfly.map.map._onCreated,ControlsPanel:{ScrollBars:ssNone},Controls:{Map:{Type:"ngPanel",L:0,R:0,T:0,B:0,style:{zIndex:1}}},Events:{OnUpdated:bbbfly.map.map._onUpdated,OnZoomChanged:null},Methods:{Dispose:bbbfly.map.map._dispose,
LayerInterface:bbbfly.map.map._layerInterface,GetMap:bbbfly.map.map._getMap,CreateMap:bbbfly.map.map._createMap,DoCreateMap:bbbfly.map.map._doCreateMap,DestroyMap:bbbfly.map.map._destroyMap,SetMaxBounds:bbbfly.map.map._setMaxBounds,SetBoundsPadding:bbbfly.map.map._setBoundsPadding,FitBounds:bbbfly.map.map._fitBounds,SetMinZoom:bbbfly.map.map._setMinZoom,SetMaxZoom:bbbfly.map.map._setMaxZoom,EnableAnimation:bbbfly.map.map._enableAnimation,SetView:bbbfly.map.map._setView,SetZoom:bbbfly.map.map._setZoom,
GetZoom:bbbfly.map.map._getZoom,ZoomIn:bbbfly.map.map._zoomIn,ZoomOut:bbbfly.map.map._zoomOut,SetCenter:bbbfly.map.map._setCenter,GetCenter:bbbfly.map.map._getCenter,GetLayer:bbbfly.map.map._getLayer,AddLayers:bbbfly.map.map._addLayers,AddLayer:bbbfly.map.map._addLayer,RemoveLayers:bbbfly.map.map._removeLayers,RemoveLayer:bbbfly.map.map._removeLayer}});return ngCreateControlAsType(a,"ngGroup",b,c)};
bbbfly.Map.layer={image:"ImageLayer",tile:"TileLayer",wms:"WMSLayer",arcgis_online:"ArcGISOnlineLayer",arcgis_server:"ArcGISServerLayer",arcgis_enterprise:"ArcGISEnterpriseLayer",mapbox_tile:"MapboxTileLayer",mapbox_style:"MapboxStyleLayer"};bbbfly.Map.crs={WorldMercator:"EPSG3395",PseudoMercator:"EPSG3857",WGS84:"EPSG4326"};ngUserControls=ngUserControls||[];ngUserControls.bbbfly_map={OnInit:function(){ngRegisterControlType("bbbfly.Map",bbbfly.Map)}};
bbbfly.Map.Layer={map:{Url:"url",CrossOrigin:"crossOrigin",ZIndex:"zIndex",Opacity:"opacity",ClassName:"className",Attribution:"attribution"},options:{crossOrigin:!1,zIndex:1,opacity:1,className:""}};bbbfly.Map.ImageLayer={extends:"Layer",type:"L.ImageOverlay",map:{ErrorUrl:"errorOverlayUrl",Bounds:"bounds"}};
bbbfly.Map.TileLayer={extends:"Layer",type:"L.TileLayer",map:{ErrorUrl:"errorTileUrl",Bounds:"bounds",MinZoom:"minZoom",MaxZoom:"maxZoom",TileSize:"tileSize"},options:{minZoom:1,maxZoom:18,tileSize:256,detectRetina:!0}};bbbfly.Map.WMSLayer={extends:"TileLayer",type:"L.TileLayer.wms",map:{Layers:"layers",Styles:"styles",Format:"format",Version:"version",Transparent:"transparent",Crs:"crs"},options:{format:"image/png32",version:"1.3.0",transparent:!0}};
bbbfly.Map.ArcGISOnlineLayer={extends:"TileLayer",type:"L.esri.TiledMapLayer"};bbbfly.Map.ArcGISServerLayer={extends:"TileLayer",type:"L.esri.TiledMapLayer"};bbbfly.Map.ArcGISEnterpriseLayer={extends:"ImageLayer",type:"L.esri.DynamicMapLayer",map:{Format:"format",Layers:"layers",Transparent:"transparent"},options:{format:"png32",transparent:!0}};bbbfly.Map.MapboxTileLayer={extends:"TileLayer",map:{MapId:"mapId",AccessToken:"accessToken"},onCreateOptions:bbbfly.map.layer.mapbox_tile._oncreateOptions};
bbbfly.Map.MapboxStyleLayer={extends:"TileLayer",map:{StyleUrl:"styleUrl",AccessToken:"accessToken"},pattern:/^mapbox:\/\/styles\/([\w-]+\/[a-z0-9]+)[^?]*(\?(.*))?$/,onCreateOptions:bbbfly.map.layer.mapbox_style._oncreateOptions};
