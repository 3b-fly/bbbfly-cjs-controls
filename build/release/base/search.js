/*!
 * @author Jan Nejedly support@3b-fly.eu
 * @copyright Jan Nejedly
 * @version 2.0.1
 * @license see license in 'LICENSE' file
*/

var bbbfly=bbbfly||{};bbbfly.search={};bbbfly.searchedit={};bbbfly.searchbox={};bbbfly.listsearchbox={};bbbfly.search._normalizeText=function(a){String.isString(a)&&(a=bbbfly.locale.TextToAscii(a),a=String.trim(a).toLowerCase(),a=a.replace(/\s+/gu," "),a=a.replace(/[^a-zA-Z0-9\s]/gu,""));return a};
bbbfly.searchedit._search=function(a){String.isString(a)&&this.SetText(a);if(Function.isFunction(this.OnSearch)&&!this.OnSearch(a))return!1;a=this.GetText();return Function.isFunction(this.DoSearch)?this.DoSearch(a):!1};bbbfly.searchedit._clearSearch=function(){this.SetText("");Function.isFunction(this.HideHint)&&this.HideHint("noresults");this.SetFocus(!1)};
bbbfly.searchedit._setSearchResults=function(a){return Array.isArray(a)?(this._SearchResults={count:a.length,results:a,current:0<a.length?0:null},0<a.length?Function.isFunction(this.OnSearchResults)&&this.OnSearchResults(this._SearchResults):Function.isFunction(this.OnNoSearchResults)&&this.OnNoSearchResults(),!0):!1};bbbfly.searchedit._onNoSearchResults=function(){Function.isFunction(this.ShowHint)&&this.ShowHint("noresults")};
bbbfly.searchedit._onTextChanged=function(){Function.isFunction(this.HideHint)&&this.HideHint("noresults")};bbbfly.searchedit._onKeyUp=function(a){return 13===(a.which|a.keyCode)?(this._ignoreEnter?this._ignoreEnter=!1:(a=this.GetButton("search"))&&a.Visible&&a.Click&&(a.Click(),this.SetFocus(!1)),!1):!0};
bbbfly.searchbox._onSearchResults=function(a){var b=[];if(a){for(var c=a.count>this.MaxResultItems,d=c?this.MaxResultItems-1:this.MaxResultItems,e=0,g=0;g<d;g++){var h=a.results[g];if(!h)break;e++;var f=String.isString(this.ResultNameProperty)?this.ResultNameProperty:"text";f=String.isString(h[f])?h[f]:"";b.push({Text:f,data:h})}c&&(c="",a=a.count-e,String.isString(this.MoreItemsText_part1)&&(c+=ngTxt(this.MoreItemsText_part1)),c+=a,String.isString(this.MoreItemsText_part2)&&(c+=ngTxt(this.MoreItemsText_part2)),
b.push({Count:a,Text:c,Enabled:!1}))}this.DropDownControl.SetItems(b);this.DropDown()};bbbfly.searchbox._onNoSearchResults=function(){this.ListItem=null;this.DropDownControl.SetItems(null);this.HideDropDown()};bbbfly.searchbox._clearSearch=function(){this.ClearSearch.callParent();this.ListItem=null;this.DropDownControl.SetItems(null);this.HideDropDown()};
bbbfly.searchbox._onListKeyDown=function(a){switch(a.which|a.keyCode){case 13:this.DropDownOwner._ignoreEnter=!0;break;case 27:return this.DropDownOwner.SetFocusAfter(),!1;case 38:case 40:case 33:case 34:case 37:case 39:break;default:this.DropDownOwner.SetFocusAfter()}return!0};bbbfly.searchbox._selectListItemWithFocus=function(a){(a=this.SelectDropDownItem(a))&&this.DropDownOwner.SetFocusAfter();return a};
bbbfly.listsearchbox._onUpdated=function(){if(!this._SearchList&&this.ListID){var a=ngGetControlById(this.ListID);a&&this.SetSearchList(a)}};bbbfly.listsearchbox._setSearchList=function(a){return a&&Function.isFunction(a.CtrlInheritsFrom)&&a.CtrlInheritsFrom("bbbfly.List")?(this._SearchList=a,a._ExpandedBySearch=null,a.AddEvent("OnCollapsed",function(a,c){a=a._ExpandedBySearch;if("object"===typeof a&&a)for(var b in a)if(a[b].ID===c.ID){a.splice(b,1);break}}),!0):!1};
bbbfly.listsearchbox._clearSearch=function(){this.ClearSearch.callParent();var a=this.GetButton("up"),b=this.GetButton("down");a&&a.SetVisible(!1);b&&b.SetVisible(!1);this.Update()};
bbbfly.listsearchbox._doSearch=function(a){var b=this._SearchList;if(!b||!b.Items||1>b.Items.length)return!1;a=bbbfly.search._normalizeText(a);if(!a)return!1;if(Function.isFunction(this.CompareItem)){var c=[],d=this,e=function(g){for(var h in g){var f=g[h];d.CompareItem(b,f,a)&&c.push(f);"object"===typeof f.Items&&e(f.Items)}};e(b.Items);this.SetSearchResults(c);return!0}this.SetSearchResults([]);return!1};
bbbfly.listsearchbox._compareItem=function(a,b,c){a=Function.isFunction(this.GetItemText)?this.GetItemText(b):Function.isFunction(a.OnGetText)?a.OnGetText(a,b):b.Text;if(!String.isString(a))return!1;a=bbbfly.search._normalizeText(a);return(new RegExp("^(.*)"+c+"(.*)$")).test(a)?!0:!1};bbbfly.listsearchbox._onNoSearchResult=function(){var a=this.GetButton("up"),b=this.GetButton("down");a&&a.SetVisible(!1);b&&b.SetVisible(!1);this.Update()};
bbbfly.listsearchbox._onSearchResults=function(a){var b=this._SearchList;if(b){var c=a.results[0];bbbfly.listsearchbox._showListItem(b,c);b.ScrollToItem(c);b.HighlightItem(c);b=this.GetButton("up");c=this.GetButton("down");b&&b.SetVisible(!1);c&&c.SetVisible(1<a.results.length);this.Update();this.SetFocusAfter()}};bbbfly.listsearchbox._onTextChanged=function(){var a=this.GetButton("up"),b=this.GetButton("down");a&&a.SetVisible(!1);b&&b.SetVisible(!1);this.Update()};
bbbfly.listsearchbox._onKeyUp=function(a){var b=null;switch(a.which|a.keyCode){case 13:b="search";break;case 38:b="up";break;case 40:b="down"}b&&(b=this.GetButton(b));return b&&b.Visible&&Function.isFunction(b.Click)?(b.Click(),!1):!0};bbbfly.listsearchbox._showNextResult=function(a,b){if(a._SearchResults&&b){var c=a._SearchResults;bbbfly.listsearchbox._showResult(a,b,c,c.current+1)}};
bbbfly.listsearchbox._showPreviousResult=function(a,b){if(a._SearchResults&&b){var c=a._SearchResults;bbbfly.listsearchbox._showResult(a,b,c,c.current-1)}};bbbfly.listsearchbox._showResult=function(a,b,c,d){if(b&&c&&-1<d&&d<c.count){var e=c.results[d];bbbfly.listsearchbox._showListItem(b,e);b.ScrollToItem(e);b.HighlightItem(e);b=a.GetButton("up");e=a.GetButton("down");b&&b.SetVisible(0<d);e&&e.SetVisible(d<c.count-1);c.current=d;a.Update()}};
bbbfly.listsearchbox._showListItem=function(a,b){a.BeginUpdate();bbbfly.listsearchbox._hideListItem(a);var c=[],d=function(a){a.Parent&&(a.Parent.Collapsed&&c.push(a.Parent),d(a.Parent))};d(b);if(0<c.length)for(var e in c)a.Expand(c[e]);a._ExpandedBySearch=c;a.EndUpdate()};
bbbfly.listsearchbox._hideListItem=function(a){a.BeginUpdate();if(a._ExpandedBySearch&&0<a._ExpandedBySearch.length){var b=[],c;for(c in a._ExpandedBySearch)b.push(a._ExpandedBySearch[c]);for(var d in b)a.Collapse(b[d])}a._ExpandedBySearch=null;a.EndUpdate()};
bbbfly.SearchEdit=function(a,b,c){a=a||{};ng_MergeDef(a,{Data:{HintMessages:{noresults:"bbbfly_searchedit_noresults"},SearchImg:null,_SearchResults:null},Events:{OnTextChanged:bbbfly.searchedit._onTextChanged,OnKeyUp:bbbfly.searchedit._onKeyUp,OnSearch:null,OnSearchResults:null,OnNoSearchResults:bbbfly.searchedit._onNoSearchResults},Methods:{Search:bbbfly.searchedit._search,ClearSearch:bbbfly.searchedit._clearSearch,SetSearchResults:bbbfly.searchedit._setSearchResults,DoSearch:null}});a.Data.SearchImg&&
ng_MergeDef(a,{Buttons:{search:{Type:"ngButton",Data:{LeftImg:a.Data.SearchImg},Events:{OnClick:function(){this.Owner.Search();return!0}}}}});return ngCreateControlAsType(a,"bbbfly.Edit",b,c)};
bbbfly.SearchBox=function(a,b,c){a=a||{};ng_MergeDef(a,{Data:{MaxResultItems:5,ResultNameProperty:"name",MoreItemsText_part1:"bbbfly_searchbox_more_part1",MoreItemsText_part2:"bbbfly_searchbox_more_part2"},DropDown:{Type:"ngList",Events:{OnKeyDown:bbbfly.searchbox._onListKeyDown},Methods:{SelectDropDownItemWithFocus:bbbfly.searchbox._selectListItemWithFocus}},Events:{OnSearchResults:bbbfly.searchbox._onSearchResults,OnNoSearchResults:bbbfly.searchbox._onNoSearchResults},Methods:{ClearSearch:bbbfly.searchbox._clearSearch}});
return ngCreateControlAsType(a,"bbbfly.SearchEdit",b,c)};
bbbfly.ListSearchBox=function(a,b,c){a=a||{};ng_MergeDef(a,{Data:{ListID:null,DownImg:null,UpImg:null,_SearchList:null},Events:{OnUpdated:bbbfly.listsearchbox._onUpdated,OnTextChanged:bbbfly.listsearchbox._onTextChanged,OnKeyUp:bbbfly.listsearchbox._onKeyUp,OnNoSearchResults:bbbfly.listsearchbox._onNoSearchResults,OnSearchResults:bbbfly.listsearchbox._onSearchResults},Methods:{SetSearchList:bbbfly.listsearchbox._setSearchList,ClearSearch:bbbfly.listsearchbox._clearSearch,DoSearch:bbbfly.listsearchbox._doSearch,
CompareItem:bbbfly.listsearchbox._compareItem,GetItemText:null}});a.Data.DownImg&&ng_MergeDef(a,{Buttons:{down:{Type:"ngButton",Data:{LeftImg:a.Data.DownImg,Visible:!1},Events:{OnClick:function(){var a=this.Owner;bbbfly.listsearchbox._showNextResult(a,a._SearchList);return!0}}}}});a.Data.UpImg&&ng_MergeDef(a,{Buttons:{up:{Type:"ngButton",Data:{LeftImg:a.Data.UpImg,Visible:!1},Events:{OnClick:function(){var a=this.Owner;bbbfly.listsearchbox._showPreviousResult(a,a._SearchList);return!0}}}}});return ngCreateControlAsType(a,
"bbbfly.SearchEdit",b,c)};ngUserControls=ngUserControls||[];ngUserControls.bbbfly_search={OnInit:function(){ngRegisterControlType("bbbfly.SearchEdit",bbbfly.SearchEdit);ngRegisterControlType("bbbfly.SearchBox",bbbfly.SearchBox);ngRegisterControlType("bbbfly.ListSearchBox",bbbfly.ListSearchBox)}};
